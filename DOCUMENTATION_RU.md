# –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å–µ—Ä–≤–∏—Å—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞–º–∏

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ](#–æ–±—â–µ–µ-–æ–ø–∏—Å–∞–Ω–∏–µ)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
3. [API Endpoints](#api-endpoints)
4. [–¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö](#—Ç–∏–ø—ã-–¥–∞–Ω–Ω—ã—Ö)
5. [–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Flutter](#–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ-—Å-flutter)
6. [–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π](#—Å–æ–∑–¥–∞–Ω–∏–µ-–ø–ª–∞—Ç–µ–∂–µ–π)
7. [–°–∏—Å—Ç–µ–º–∞ —Ç–æ–∫–µ–Ω–æ–≤](#—Å–∏—Å—Ç–µ–º–∞-—Ç–æ–∫–µ–Ω–æ–≤)
8. [–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∏-—Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤)
9. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)
10. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

---

## –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

–í–µ–±-—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–±–æ–Ω–µ–Ω—Ç–∞–º–∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø—Ä–∏–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª—ã MegaPay. –°–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å Flutter-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π –∏ Vtiger CRM –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ Vtiger CRM
- üîç –ü–æ–∏—Å–∫ –∞–±–æ–Ω–µ–Ω—Ç–æ–≤ –ø–æ –ª–∏—Ü–µ–≤–æ–º—É —Å—á–µ—Ç—É, –§–ò–û –∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–º—É –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—é
- üí≥ –ü—Ä–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª (–∫–∞—Ä—Ç–∞) –∏ –Ω–∞–ª–∏—á–Ω—ã–º–∏
- üîë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ MegaPay
- ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:

```
controllers/
‚îú‚îÄ‚îÄ app.js                    # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (1954 —Å—Ç—Ä–æ–∫–∏)
‚îú‚îÄ‚îÄ cotroller.php             # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (500 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ terminal_settings.php     # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤
‚îú‚îÄ‚îÄ get_token.php             # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –æ—Ç MegaPay
‚îú‚îÄ‚îÄ settoken.php              # Callback –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
‚îú‚îÄ‚îÄ get_token_status.php      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç–æ–∫–µ–Ω–∞
‚îú‚îÄ‚îÄ check_tokens.php          # –í–∏–∑—É–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
‚îú‚îÄ‚îÄ config.php                # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è MegaPay
‚îú‚îÄ‚îÄ config.js                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
‚îú‚îÄ‚îÄ language.js               # –Ø–∑—ã–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
‚îú‚îÄ‚îÄ index.html                # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ style.css                 # –°—Ç–∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:

1. **Frontend (JavaScript)**
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è–º–∏
   - –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è —Å Flutter —á–µ—Ä–µ–∑ `window.flutter_inappwebview`
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

2. **Backend (PHP)**
   - API endpoints –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Vtiger CRM
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏ MegaPay
   - –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

3. **Flutter Integration**
   - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä–∏–π–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª
   - –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π

---

## API Endpoints

### –ë–∞–∑–æ–≤—ã–π URL
```
POST /controllers/cotroller.php
```

–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –º–µ—Ç–æ–¥–æ–º `POST` —Å —Ç–µ–ª–æ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.

### –§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:
```json
{
  "action": "actionName",
  "param1": "value1",
  "param2": "value2"
}
```

### –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
```json
{
  "success": true|false,
  "message": "–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞",
  "data": {} // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}
```

---

### 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

#### `checkUser` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "action": "checkUser",
  "username": "user@example.com",
  "hashed_password": "hash_–æ—Ç_–ø–∞—Ä–æ–ª—è"
}
```

**–û—Ç–≤–µ—Ç (—É—Å–ø–µ—Ö):**
```json
{
  "success": true,
  "message": "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Vtiger –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!",
  "user_id": "1",
  "username": "user@example.com",
  "fullname": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
}
```

**–û—Ç–≤–µ—Ç (–æ—à–∏–±–∫–∞):**
```json
{
  "success": false,
  "message": "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å."
}
```

---

#### `checkAuth` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "action": "checkAuth",
  "phoneIdentifier": "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"
}
```

**–û—Ç–≤–µ—Ç (–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω):**
```json
{
  "success": true,
  "data": {
    "vtiger_user_id": "1",
    "username": "user@example.com",
    "expiration": "2024-01-15 12:00:00",
    "fullname": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
  }
}
```

**–û—Ç–≤–µ—Ç (–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω):**
```json
{
  "success": true,
  "data": "empty",
  "message": "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏."
}
```

---

#### `addAuth` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "action": "addAuth",
  "phoneIdentifier": "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",
  "vtiger_user_id": "1"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "message": "–ù–æ–≤–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞."
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ 7 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è.

---

#### `updateAuth` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "action": "updateAuth",
  "phoneIdentifier": "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",
  "vtiger_user_id": "1"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "message": "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞."
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü—Ä–æ–¥–ª–µ–≤–∞–µ—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ 7 –¥–Ω–µ–π.

---

#### `logout` - –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "action": "logout",
  "phoneIdentifier": "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "message": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã."
}
```

---

### 2. –ü–æ–∏—Å–∫ –∞–±–æ–Ω–µ–Ω—Ç–æ–≤

#### `searchSubscribers` - –ü–æ–∏—Å–∫ –∞–±–æ–Ω–µ–Ω—Ç–æ–≤

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "action": "searchSubscribers",
  "mp_id": "1",
  "fio": "–ò–≤–∞–Ω–æ–≤",           // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  "account_number": "12345"  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}
```

**–û—Ç–≤–µ—Ç (—É—Å–ø–µ—Ö):**
```json
{
  "success": true,
  "message": "–ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω.",
  "data": [
    {
      "id": "123",
      "account_number": "12345",
      "full_name": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
      "locality": "–ë–∏—à–∫–µ–∫",
      "street": "—É–ª. –ß—É–π",
      "house": "123",
      "flat": "45",
      "address": "–ë–∏—à–∫–µ–∫, —É–ª. –ß—É–π, 123, –∫–≤. 45",
      "phone": "+996555123456",
      "balance": "-150.50"
    }
  ],
  "count": 1
}
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `mp_id` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - ID –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
- `fio` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π) - –§–ò–û –¥–ª—è –ø–æ–∏—Å–∫–∞ (—á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
- `account_number` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π) - –õ–∏—Ü–µ–≤–æ–π —Å—á–µ—Ç (—á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ú–∞–∫—Å–∏–º—É–º 500 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞ –∑–∞–ø—Ä–æ—Å
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –ª–∏—Ü–µ–≤–æ–º—É —Å—á–µ—Ç—É

---

#### `getServices` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—Å–ª—É–≥

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "action": "getServices"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "message": "–£—Å–ª—É–≥–∏ –ø–æ–ª—É—á–µ–Ω—ã.",
  "services": [
    {
      "id": "1",
      "name": "–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ"
    },
    {
      "id": "2",
      "name": "–≠–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ"
    }
  ]
}
```

---

### 3. –ü–ª–∞—Ç–µ–∂–∏

#### `processPayment` - –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "action": "processPayment",
  "ls": "12345",
  "service_id": "1",
  "service": "–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ",
  "amount": 1000.50,
  "payment_type": "cash|terminal",
  "date": "2024-01-15",
  "user_id": "1",
  "rnn": "123456789012"  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ç–æ–ª—å–∫–æ –¥–ª—è terminal
}
```

**–û—Ç–≤–µ—Ç (—É—Å–ø–µ—Ö):**
```json
{
  "success": true,
  "message": "–ü–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω",
  "payment_id": "456"
}
```

**–û—Ç–≤–µ—Ç (–æ—à–∏–±–∫–∞):**
```json
{
  "success": false,
  "message": "–õ–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
}
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `ls` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - –õ–∏—Ü–µ–≤–æ–π —Å—á–µ—Ç –∞–±–æ–Ω–µ–Ω—Ç–∞
- `service_id` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - ID —É—Å–ª—É–≥–∏
- `service` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - –ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
- `amount` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ (float)
- `payment_type` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - –¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞: `"cash"` –∏–ª–∏ `"terminal"`
- `date` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - –î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `YYYY-MM-DD`
- `user_id` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞)
- `rnn` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π) - RNN –æ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ MegaPay (—Ç–æ–ª—å–∫–æ –¥–ª—è `terminal`)

**–¢–∏–ø—ã –ø–ª–∞—Ç–µ–∂–µ–π:**
- `cash` - –ù–∞–ª–∏—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂, —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É
- `terminal` - –ü–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª, —Ç—Ä–µ–±—É–µ—Ç RNN –æ—Ç MegaPay

---

#### `logPayment` - –ó–∞–ø–∏—Å—å –ª–æ–≥–∞ –ø–ª–∞—Ç–µ–∂–∞

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "action": "logPayment",
  "message": "–ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω | LS: 12345 | Amount: 1000.50"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "message": "–õ–æ–≥ –∑–∞–ø–∏—Å–∞–Ω"
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –õ–æ–≥–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Ñ–∞–π–ª `payments.log`.

---

## –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

### –û–±—ä–µ–∫—Ç –∞–±–æ–Ω–µ–Ω—Ç–∞ (Subscriber)

```typescript
interface Subscriber {
  id: string;                    // ID –∑–∞–ø–∏—Å–∏ –≤ Vtiger
  account_number: string;        // –õ–∏—Ü–µ–≤–æ–π —Å—á–µ—Ç
  full_name: string;             // –§–ò–û –∞–±–æ–Ω–µ–Ω—Ç–∞
  locality: string;              // –ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç
  street: string;                // –£–ª–∏—Ü–∞
  house: string;                 // –ù–æ–º–µ—Ä –¥–æ–º–∞
  flat: string;                  // –ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã
  address: string;               // –ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å
  phone: string;                 // –¢–µ–ª–µ—Ñ–æ–Ω
  balance: string;                // –ë–∞–ª–∞–Ω—Å (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)
}
```

### –û–±—ä–µ–∫—Ç —É—Å–ª—É–≥–∏ (Service)

```typescript
interface Service {
  id: string;                    // ID —É—Å–ª—É–≥–∏
  name: string;                  // –ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
}
```

### –û–±—ä–µ–∫—Ç –ø–ª–∞—Ç–µ–∂–∞ (Payment)

```typescript
interface Payment {
  ls: string;                     // –õ–∏—Ü–µ–≤–æ–π —Å—á–µ—Ç
  service_id: string;            // ID —É—Å–ª—É–≥–∏
  service: string;               // –ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
  amount: number;                // –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞
  payment_type: "cash" | "terminal";  // –¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞
  date: string;                   // –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
  user_id: string;               // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  rnn?: string;                  // RNN –æ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  megapay_token?: string;        // –¢–æ–∫–µ–Ω MegaPay (–¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)
  vat_value?: number;            // –ù–î–° (12.00)
  st_value?: number;             // –ù–°–ü (2.00)
  controllerName?: string;       // –ò–º—è –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞
}
```

### –û–±—ä–µ–∫—Ç —Ç–æ–∫–µ–Ω–∞ (Token)

```typescript
interface Token {
  msgNum: string;                 // –ù–æ–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
  opLogin: string;                // –õ–æ–≥–∏–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
  token: string;                  // –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  tokenTimeout: number;           // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞ (—Å–µ–∫—É–Ω–¥—ã)
  serverTime: string;             // –í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞ MegaPay
  receivedAt: string;             // –í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
  expiresAt: string;             // –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
}
```

### –û–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ (Terminal Response)

```typescript
interface TerminalResponse {
  result?: {
    code: number;                 // –ö–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (0 = —É—Å–ø–µ—Ö)
    description?: string;         // –û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    RNN?: string;                 // RNN —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç)
  };
  transaction?: {
    instrumentSpecificData?: {
      rrn?: string;               // RNN —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç)
    };
  };
  error?: string;                 // –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
  errorCode?: number;             // –ö–æ–¥ –æ—à–∏–±–∫–∏
  message?: string;               // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
}
```

---

## –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Flutter

### JavaScript ‚Üí Flutter

#### 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä–∏–π–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞

```javascript
if (window.flutter_inappwebview) {
  window.flutter_inappwebview.callHandler("getSerialNumber");
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:** Flutter –≤—ã–∑—ã–≤–∞–µ—Ç `window.getSerialNumber(serialNumber)`

---

#### 2. –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ –≤ Flutter

```javascript
const paymentData = {
  action: "processPayment",
  ls: "12345",
  service_id: "1",
  service: "–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ",
  amount: 1000.50,
  payment_type: "CARD",  // –∏–ª–∏ "CASH"
  date: "2024-01-15",
  controllerName: "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
  user_id: "1",
  megapay_token: "token_here",  // –¢–æ–ª—å–∫–æ –¥–ª—è CARD
  vat_value: 12.00,
  st_value: 2.00
};

window.flutter_inappwebview.callHandler("onPayment", paymentData);
```

**–¢–∏–ø—ã –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è Flutter:**
- `CARD` - –ü–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª (—Ç—Ä–µ–±—É–µ—Ç `megapay_token`)
- `CASH` - –ù–∞–ª–∏—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂ (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)

---

#### 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã—Ö–æ–¥–µ –∏–∑ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è

```javascript
if (window.flutter_inappwebview) {
  window.flutter_inappwebview.callHandler("onMunicipalLogout");
}
```

---

### Flutter ‚Üí JavaScript

#### 1. –ü–µ—Ä–µ–¥–∞—á–∞ —Å–µ—Ä–∏–π–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞

```dart
webViewController.evaluateJavascript(
  'window.getSerialNumber("$serialNumber")'
);
```

**–ò–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏:**
```dart
webViewController.evaluateJavascript(
  'window.getTerminalSerialNumber("$serialNumber")'
);
```

---

#### 2. –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞

**–£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂:**
```dart
final responseData = {
  'result': {
    'code': 0,
    'description': 'Payment successful',
    'RNN': '123456789012'  // RNN –æ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
  },
  // –ò–ª–∏ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç:
  'transaction': {
    'instrumentSpecificData': {
      'rrn': '123456789012'
    }
  }
};

webViewController.evaluateJavascript(
  'window.createPaymentAfterFlutterConfirmation(${jsonEncode(responseData)})'
);
```

**–û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞:**
```dart
final errorData = {
  'error': 'Payment failed',
  'errorCode': 1,
  'message': 'Insufficient funds'
};

webViewController.evaluateJavascript(
  'window.createPaymentAfterFlutterConfirmation(${jsonEncode(errorData)})'
);
```

---

### –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Flutter

```dart
import 'package:flutter_inappwebview/flutter_inappwebview.dart';

class PaymentWebView extends StatefulWidget {
  @override
  _PaymentWebViewState createState() => _PaymentWebViewState();
}

class _PaymentWebViewState extends State<PaymentWebView> {
  InAppWebViewController? webViewController;

  @override
  Widget build(BuildContext context) {
    return InAppWebView(
      initialUrlRequest: URLRequest(
        url: WebUri("https://your-domain.com/controllers/index.html")
      ),
      onWebViewCreated: (controller) {
        webViewController = controller;
      },
      onLoadStop: (controller, url) {
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setupJavaScriptHandlers();
      },
    );
  }

  void setupJavaScriptHandlers() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–∏–π–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞
    webViewController?.addJavaScriptHandler(
      handlerName: "getSerialNumber",
      callback: (args) async {
        final serialNumber = await getTerminalSerialNumber();
        webViewController?.evaluateJavascript(
          source: 'window.getSerialNumber("$serialNumber")'
        );
      }
    );

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–ª–∞—Ç–µ–∂–∞
    webViewController?.addJavaScriptHandler(
      handlerName: "onPayment",
      callback: (args) async {
        if (args.isNotEmpty) {
          final paymentData = args[0] as Map<String, dynamic>;
          await processPayment(paymentData);
        }
      }
    );

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞
    webViewController?.addJavaScriptHandler(
      handlerName: "onMunicipalLogout",
      callback: (args) async {
        await performMunicipalLogout();
      }
    );
  }

  Future<String> getTerminalSerialNumber() async {
    // –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
    // –ù–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–ª–∏ API
    return "TERMINAL123456";
  }

  Future<void> processPayment(Map<String, dynamic> paymentData) async {
    try {
      final paymentType = paymentData['payment_type'] as String;
      
      if (paymentType == 'CARD') {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª
        final result = await processCardPayment(paymentData);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ JavaScript
        webViewController?.evaluateJavascript(
          source: 'window.createPaymentAfterFlutterConfirmation(${jsonEncode(result)})'
        );
      } else if (paymentType == 'CASH') {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–ª–∏—á–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
        final result = await processCashPayment(paymentData);
        
        webViewController?.evaluateJavascript(
          source: 'window.createPaymentAfterFlutterConfirmation(${jsonEncode(result)})'
        );
      }
    } catch (e) {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É
      final errorData = {
        'error': e.toString(),
        'errorCode': 1,
        'message': 'Payment processing failed'
      };
      
      webViewController?.evaluateJavascript(
        source: 'window.createPaymentAfterFlutterConfirmation(${jsonEncode(errorData)})'
      );
    }
  }

  Future<Map<String, dynamic>> processCardPayment(Map<String, dynamic> data) async {
    // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–º
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
    return {
      'result': {
        'code': 0,
        'description': 'Payment successful',
        'RNN': '123456789012'
      }
    };
  }

  Future<Map<String, dynamic>> processCashPayment(Map<String, dynamic> data) async {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–ª–∏—á–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
    return {
      'result': {
        'code': 0,
        'description': 'Cash payment recorded'
      }
    };
  }

  Future<void> performMunicipalLogout() async {
    // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
  }
}
```

---

## –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π

### –ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞

#### 1. –ù–∞–ª–∏—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂ (CASH)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –∞–±–æ–Ω–µ–Ω—Ç–∞
2. –í—ã–±–∏—Ä–∞–µ—Ç —É—Å–ª—É–≥—É –∏ –≤–≤–æ–¥–∏—Ç —Å—É–º–º—É
3. –ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "üíµ –ù–∞–ª–∏—á–Ω—ã–µ"
4. JavaScript –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ Flutter —á–µ—Ä–µ–∑ onPayment
5. Flutter –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂
6. Flutter –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ createPaymentAfterFlutterConfirmation
7. JavaScript —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ processPayment API
8. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω MegaPay
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
- –°–æ–∑–¥–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç Flutter

---

#### 2. –¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂ (CARD)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –∞–±–æ–Ω–µ–Ω—Ç–∞
2. –í—ã–±–∏—Ä–∞–µ—Ç —É—Å–ª—É–≥—É –∏ –≤–≤–æ–¥–∏—Ç —Å—É–º–º—É
3. –ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "üí≥ –¢–µ—Ä–º–∏–Ω–∞–ª"
4. JavaScript –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —É Flutter (getSerialNumber)
5. Flutter –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä (getSerialNumber callback)
6. JavaScript –ø—Ä–æ–≤–µ—Ä—è–µ—Ç operator_login –≤ –ë–î –ø–æ —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É
7. JavaScript –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω MegaPay (get_token.php)
8. JavaScript –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω (get_token_status.php)
9. JavaScript –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞ + —Ç–æ–∫–µ–Ω –≤ Flutter (onPayment)
10. Flutter –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª
11. Flutter –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç + RNN (createPaymentAfterFlutterConfirmation)
12. JavaScript —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ processPayment API —Å RNN
13. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –¢—Ä–µ–±—É–µ—Ç —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
- –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π operator_login –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
- –¢—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω MegaPay
- –¢—Ä–µ–±—É–µ—Ç RNN –æ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

---

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è Flutter

```javascript
{
  action: "processPayment",
  ls: "12345",                    // –õ–∏—Ü–µ–≤–æ–π —Å—á–µ—Ç
  service_id: "1",                // ID —É—Å–ª—É–≥–∏
  service: "–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ",       // –ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
  amount: 1000.50,                // –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞
  payment_type: "CARD",           // CARD –∏–ª–∏ CASH
  date: "2024-01-15",             // –î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞
  controllerName: "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",  // –ò–º—è –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞
  user_id: "1",                   // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  megapay_token: "token_here",   // –¢–æ–∫–µ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è CARD)
  vat_value: 12.00,               // –ù–î–°
  st_value: 2.00                  // –ù–°–ü
}
```

---

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–∞

JavaScript –æ–∂–∏–¥–∞–µ—Ç –æ–¥–∏–Ω –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:

**–§–æ—Ä–º–∞—Ç 1 (–Ω–æ–≤—ã–π):**
```json
{
  "transaction": {
    "instrumentSpecificData": {
      "rrn": "123456789012"
    }
  },
  "result": {
    "code": 0
  }
}
```

**–§–æ—Ä–º–∞—Ç 2 (—Å—Ç–∞—Ä—ã–π):**
```json
{
  "result": {
    "code": 0,
    "RNN": "123456789012"
  }
}
```

**–§–æ—Ä–º–∞—Ç –æ—à–∏–±–∫–∏:**
```json
{
  "error": "Payment failed",
  "errorCode": 1,
  "message": "Insufficient funds"
}
```

---

## –°–∏—Å—Ç–µ–º–∞ —Ç–æ–∫–µ–Ω–æ–≤

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ MegaPay

#### Endpoint: `get_token.php`

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "serial_number": "TERMINAL123456"
}
```

**–û—Ç–≤–µ—Ç (—É—Å–ø–µ—Ö):**
```json
{
  "success": true,
  "httpCode": 200,
  "response": {
    "@MsgNum": "req_1234567890",
    "OpLogin": "operator@example.com",
    "Token": "abc123def456...",
    "TokenTimeout": 3600,
    "ServerTime": "15.01.2024 12:00:00 GMT+6"
  },
  "operator_login_used": "operator@example.com"
}
```

**–û—Ç–≤–µ—Ç (–æ—à–∏–±–∫–∞):**
```json
{
  "success": false,
  "error": "–î–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω operator_login",
  "message": "–î–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω operator_login..."
}
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç `serial_number` –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
2. –ò—â–µ—Ç `operator_login` –≤ —Ç–∞–±–ª–∏—Ü–µ `terminal_settings` –ø–æ —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ MegaPay API —Å `operator_login`
4. MegaPay –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –Ω–∞ callback URL (`settoken.php`)
5. –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `tokens.json`

---

### Callback –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞

#### Endpoint: `settoken.php`

**–ó–∞–ø—Ä–æ—Å –æ—Ç MegaPay:**
```json
{
  "@MsgNum": "req_1234567890",
  "OpLogin": "operator@example.com",
  "Token": "abc123def456...",
  "TokenTimeout": 3600,
  "ServerTime": "15.01.2024 12:00:00 GMT+6"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "@MsgNum": "req_1234567890",
  "ServerTime": "15.01.2024 12:00:00 GMT+6",
  "Response": {
    "Code": "00",
    "Description": "OK",
    "Info": "Token successfully received and stored"
  }
}
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω –æ—Ç MegaPay
2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `tokens.json` —Å —Ä–∞—Å—á–µ—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ MegaPay

---

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç–æ–∫–µ–Ω–∞

#### Endpoint: `get_token_status.php`

**–ó–∞–ø—Ä–æ—Å:** `GET /get_token_status.php`

**–û—Ç–≤–µ—Ç (–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω):**
```json
{
  "success": true,
  "token": "abc123def456...",
  "expiresAt": "2024-01-15 13:00:00",
  "isExpired": false,
  "opLogin": "operator@example.com",
  "receivedAt": "2024-01-15 12:00:00",
  "timeLeft": 3500
}
```

**–û—Ç–≤–µ—Ç (–∏—Å—Ç–µ–∫—à–∏–π —Ç–æ–∫–µ–Ω):**
```json
{
  "success": true,
  "token": "abc123def456...",
  "expiresAt": "2024-01-15 12:00:00",
  "isExpired": true,
  "opLogin": "operator@example.com",
  "receivedAt": "2024-01-15 11:00:00",
  "timeLeft": 0
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –¢–æ–∫–µ–Ω —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏—Å—Ç–µ–∫—à–∏–º –∑–∞ 30 —Å–µ–∫—É–Ω–¥ –¥–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è (–∑–∞–ø–∞—Å –≤—Ä–µ–º–µ–Ω–∏).

---

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ tokens.json

```json
{
  "msgNum": "req_1234567890",
  "opLogin": "operator@example.com",
  "token": "abc123def456...",
  "tokenTimeout": 3600,
  "serverTime": "15.01.2024 12:00:00 GMT+6",
  "receivedAt": "2024-01-15 12:00:00",
  "expiresAt": "2024-01-15 13:00:00"
}
```

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤

#### Endpoint: `terminal_settings.php`

### –ü–æ–ª—É—á–µ–Ω–∏–µ operator_login

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "action": "getOperatorLogin",
  "serial_number": "TERMINAL123456"
}
```

**–û—Ç–≤–µ—Ç (–Ω–∞–π–¥–µ–Ω):**
```json
{
  "success": true,
  "operator_login": "operator@example.com"
}
```

**–û—Ç–≤–µ—Ç (–Ω–µ –Ω–∞–π–¥–µ–Ω):**
```json
{
  "success": false,
  "message": "–û–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞",
  "operator_login": null
}
```

---

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ operator_login

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "action": "saveOperatorLogin",
  "serial_number": "TERMINAL123456",
  "operator_login": "operator@example.com"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "message": "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–Ω–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è. –ï—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è.

---

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã terminal_settings

```sql
CREATE TABLE terminal_settings (
  id INT AUTO_INCREMENT PRIMARY KEY,
  serial_number VARCHAR(255) UNIQUE NOT NULL,
  operator_login VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

---

### –ü—Ä–æ—Ü–µ—Å—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞"
2. JavaScript –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —É Flutter (getSerialNumber)
3. Flutter –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä
4. JavaScript –∑–∞–≥—Ä—É–∂–∞–µ—Ç operator_login –∏–∑ –ë–î (getOperatorLogin)
5. –ï—Å–ª–∏ operator_login –Ω–µ –Ω–∞–π–¥–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ñ–æ—Ä–º–∞ –≤–≤–æ–¥–∞
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç operator_login (email)
7. JavaScript —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (saveOperatorLogin)
8. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∏–ø—ã –æ—à–∏–±–æ–∫

#### 1. –û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å:**
```json
{
  "success": false,
  "message": "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å."
}
```

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω:**
```json
{
  "success": false,
  "message": "–í–∞—à–∞ —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞."
}
```

**–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞:**
```json
{
  "success": true,
  "data": "empty",
  "message": "–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω."
}
```

---

#### 2. –û—à–∏–±–∫–∏ –ø–æ–∏—Å–∫–∞

**–ù–µ –≤—ã–±—Ä–∞–Ω–æ –ú–ü:**
```json
{
  "success": false,
  "message": "–ù–µ –≤—ã–±—Ä–∞–Ω–æ –ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ"
}
```

**SQL –æ—à–∏–±–∫–∞:**
```json
{
  "success": false,
  "message": "SQL –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: [–æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏]"
}
```

---

#### 3. –û—à–∏–±–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π

**–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```json
{
  "success": false,
  "message": "–ù–µ–≤–µ—Ä–Ω—ã–µ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞."
}
```

**–õ–∏—Ü–µ–≤–æ–π —Å—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:**
```json
{
  "success": false,
  "message": "–õ–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
}
```

**–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø–ª–∞—Ç–µ–∂–∞:**
```json
{
  "success": false,
  "message": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø–ª–∞—Ç–µ–∂–∞: [—Ç–∏–ø]"
}
```

---

#### 4. –û—à–∏–±–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤

**–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω:**
```json
{
  "success": false,
  "error": "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω",
  "message": "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω..."
}
```

**Operator login –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:**
```json
{
  "success": false,
  "error": "–î–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω operator_login",
  "message": "–î–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω operator_login..."
}
```

**–¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫:**
```json
{
  "success": true,
  "isExpired": true,
  "timeLeft": 0
}
```

---

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ JavaScript

```javascript
// –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
try {
  const response = await fetch(BASE_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "processPayment",
      // ... –¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞
    })
  });

  const data = await response.json();

  if (data.success) {
    // –£—Å–ø–µ—Ö
    showPaymentSuccess("–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
  } else {
    // –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    showPaymentError(data.message || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞");
  }
} catch (error) {
  // –û—à–∏–±–∫–∞ —Å–µ—Ç–∏
  showPaymentError("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + error.message);
}
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –Ω–∞–ª–∏—á–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

```javascript
// 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –∞–±–æ–Ω–µ–Ω—Ç–∞ –∏ —É—Å–ª—É–≥—É
const paymentData = {
  action: "processPayment",
  ls: "12345",
  service_id: "1",
  service: "–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ",
  amount: 1000.50,
  payment_type: "CASH",
  date: "2024-01-15",
  controllerName: "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
  user_id: "1"
};

// 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Flutter
window.flutter_inappwebview.callHandler("onPayment", paymentData);

// 3. Flutter –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
// window.createPaymentAfterFlutterConfirmation –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

// 4. –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ createPaymentAfterFlutterConfirmation:
function createPaymentAfterFlutterConfirmation(response) {
  if (response.result && response.result.code === 0) {
    // 5. –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ –≤ —Å–∏—Å—Ç–µ–º–µ
    fetch(BASE_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "processPayment",
        ls: paymentData.ls,
        service_id: paymentData.service_id,
        service: paymentData.service,
        amount: paymentData.amount,
        payment_type: "cash",
        date: paymentData.date,
        user_id: paymentData.user_id
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showPaymentSuccess("–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
      }
    });
  }
}
```

---

### –ü—Ä–∏–º–µ—Ä 2: –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

```javascript
// 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –∞–±–æ–Ω–µ–Ω—Ç–∞ –∏ —É—Å–ª—É–≥—É, –Ω–∞–∂–∞–ª "–¢–µ—Ä–º–∏–Ω–∞–ª"
// 2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä
window.flutter_inappwebview.callHandler("getSerialNumber");

// 3. –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä (–≤ window.getSerialNumber)
function getSerialNumber(serialNumber) {
  terminalSerialNumber = serialNumber;
  
  // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º operator_login
  getOperatorLoginFromDB(serialNumber)
    .then(function(login) {
      if (!login) {
        showAlert("–ù–∞—Å—Ç—Ä–æ–π—Ç–µ operator_login –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞");
        return;
      }
      
      operatorLogin = login;
      
      // 5. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω
      return getValidToken();
    })
    .then(function(token) {
      // 6. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞
      const paymentData = {
        action: "processPayment",
        ls: "12345",
        service_id: "1",
        service: "–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ",
        amount: 1000.50,
        payment_type: "CARD",
        date: "2024-01-15",
        controllerName: "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
        user_id: "1",
        megapay_token: token
      };
      
      // 7. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Flutter
      sendPaymentToFlutter(paymentData, button, details, "CARD");
    });
}

// 8. Flutter –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å RNN
// window.createPaymentAfterFlutterConfirmation –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

// 9. –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ:
function createPaymentAfterFlutterConfirmation(response) {
  // –ò–∑–≤–ª–µ–∫–∞–µ–º RNN
  let rnn = null;
  if (response.transaction?.instrumentSpecificData?.rrn) {
    rnn = response.transaction.instrumentSpecificData.rrn;
  } else if (response.result?.RNN) {
    rnn = response.result.RNN;
  }
  
  // 10. –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ —Å RNN
  fetch(BASE_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "processPayment",
      ls: paymentData.ls,
      service_id: paymentData.service_id,
      service: paymentData.service,
      amount: paymentData.amount,
      payment_type: "terminal",
      date: paymentData.date,
      user_id: paymentData.user_id,
      rnn: rnn
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showPaymentSuccess("–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
    }
  });
}
```

---

### –ü—Ä–∏–º–µ—Ä 3: –ü–æ–∏—Å–∫ –∞–±–æ–Ω–µ–Ω—Ç–æ–≤

```javascript
// –ó–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–∞
fetch(BASE_API_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    action: "searchSubscribers",
    mp_id: "1",
    fio: "–ò–≤–∞–Ω–æ–≤",
    account_number: ""
  })
})
.then(response => response.json())
.then(data => {
  if (data.success && data.data.length > 0) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    data.data.forEach(subscriber => {
      console.log(`–ê–±–æ–Ω–µ–Ω—Ç: ${subscriber.full_name}, –õ–°: ${subscriber.account_number}`);
    });
  }
});
```

---

### –ü—Ä–∏–º–µ—Ä 4: –ü–æ–ª—É—á–µ–Ω–∏–µ —É—Å–ª—É–≥

```javascript
fetch(BASE_API_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    action: "getServices"
  })
})
.then(response => response.json())
.then(data => {
  if (data.success) {
    data.services.forEach(service => {
      console.log(`–£—Å–ª—É–≥–∞: ${service.name} (ID: ${service.id})`);
    });
  }
});
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### config.php (MegaPay)

```php
<?php
return [
    'megapay' => [
        'url' => 'https://core.megapay.pos.kg/json/GetToken',
        'callback_url' => 'https://your-domain.com/controllers/settoken.php',
        'operator_login' => 'default@example.com',  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
        'system_admin_login' => 'admin',
        'system_admin_password_hash' => 'hash_here',
        'language' => 'rus',
        'system_info' => 'PHP Payment System v1.0'
    ],
    'logging' => [
        'enabled' => true,
        'log_file' => 'token_requests.log'
    ]
];
?>
```

### config.js (Frontend)

```javascript
const CONFIG = {
    BASE_API_URL: "https://your-domain.com/controllers/cotroller.php",
    CHECK_PASS_URL: "../checkPass.php",
    ITEMS_PER_PAGE: 10,
    MODAL_Z_INDEX: 10001,
    KEYBOARD_HIDE_DELAY: 200,
    MODAL_SHOW_DELAY: 100
};

window.CONFIG = CONFIG;
```

---

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –§–∞–π–ª—ã –ª–æ–≥–æ–≤

1. **payments.log** - –õ–æ–≥–∏ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π
   - –§–æ—Ä–º–∞—Ç: `[YYYY-MM-DD HH:MM:SS] –°–æ–æ–±—â–µ–Ω–∏–µ`
   - –ü—Ä–∏–º–µ—Ä: `[2024-01-15 12:00:00] ‚úÖ –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω | PaymentID: 456 | LS: 12345 | Amount: 1000.50`

2. **token_requests.log** - –õ–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–æ–∫–µ–Ω–æ–≤
   - –§–æ—Ä–º–∞—Ç: `[YYYY-MM-DD HH:MM:SS] JSON –¥–∞–Ω–Ω—ã–µ`
   - –ü—Ä–∏–º–µ—Ä: `[2024-01-15 12:00:00] {"type":"request","data":{...}}`

3. **controller_error.log** - –û—à–∏–±–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ PHP

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **HTTPS:** –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ HTTPS
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –í—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
3. **–¢–æ–∫–µ–Ω—ã:** –¢–æ–∫–µ–Ω—ã MegaPay —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ë–î
4. **–ü–∞—Ä–æ–ª–∏:** –ü–∞—Ä–æ–ª–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ
5. **CORS:** –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∏ CORS –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
6. **SQL Injection:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (prepared statements)

---

## –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã

### Q: –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞?

A: –¢–æ–∫–µ–Ω –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞. –ü—Ä–æ—Ü–µ—Å—Å:
1. –ü–æ–ª—É—á–∞–µ—Ç—Å—è —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è operator_login –≤ –ë–î
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –≤ MegaPay API
4. –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ callback

### Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫?

A: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–æ–º –ø–ª–∞—Ç–µ–∂–µ.

### Q: –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å operator_login –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞?

A: –ß–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞" –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∏–ª–∏ —á–µ—Ä–µ–∑ API `terminal_settings.php`.

### Q: –í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É CASH –∏ CARD –ø–ª–∞—Ç–µ–∂–∞–º–∏?

A: 
- **CASH:** –ù–∞–ª–∏—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω, —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É
- **CARD:** –ü–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª, —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω –∏ RNN, —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–∞

### Q: –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å RNN –æ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–∞?

A: RNN –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –æ—Ç–≤–µ—Ç–µ –æ—Ç Flutter –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞. –ú–æ–∂–µ—Ç –±—ã—Ç—å –≤ –¥–≤—É—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö:
- `response.transaction.instrumentSpecificData.rrn` (–Ω–æ–≤—ã–π)
- `response.result.RNN` (—Å—Ç–∞—Ä—ã–π)

---

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –õ–æ–≥–∏ –≤ `payments.log` –∏ `token_requests.log`
2. –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
3. –õ–æ–≥–∏ PHP –≤ `controller_error.log`
4. –°—Ç–∞—Ç—É—Å —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ `get_token_status.php`

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** 1.0  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2024-01-15

